<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>News</title>
	<link rel="stylesheet" href="styles.css">
</head>
<body>
	<aside id="side-block" class="collapsed">
		<ul id="sources-list">
		</ul>
		<span class="expander" id="expander"></span>
	</aside>

	<main>
		<h1 id="source-title"></h1>
		<div class="articles-number-block">
			<label for="articles-number">Article Number to Show: </label>
			<select id="articles-number">
				<option value="1">1</option>
				<option value="2">2</option>
				<option value="3">3</option>
				<option value="4">4</option>
				<option value="5">5</option>
				<option value="6">6</option>
				<option value="7">7</option>
				<option value="8">8</option>
				<option value="9">9</option>
				<option value="10" selected>10</option>
			</select>
		</div>
		<div id="articles-list">
		</div>
		<div class="created">Created using <a href="https://newsapi.org/" target="_blank">NewsAPI</a></div>
	</main>

<script>
	'use strict';

	let currentSourceId = '';

	let getArticleNumber = () => {
		let selector = document.getElementById('articles-number');
		let value = selector[selector.selectedIndex].value;
		console.debug("Selected Article Number: " + value);
		return value;
	};

	let onSourceClick = (event) => {
		currentSourceId = event.target.id;
		loadSource();
		toggleExpander();
	};

	let getSourceUrl = (sourceId) => {
		return `https://newsapi.org/v2/top-headlines?sources= +
			${sourceId} +
			&apiKey=2b17f156630a4c0caf074c1251e75c02`;
	};

	let loadSource = () => {
		if (!currentSourceId) {
			return;
		}

		console.debug("loadSource() called");
		console.debug("Selected Source Id: " + currentSourceId);

		let sourceUrl = getSourceUrl(currentSourceId);
		let req = new Request(sourceUrl);
		fetch(req)
			.then((response) => {
				let articlesResult = response.json();

				articlesResult.then((promiseValue) => {
					if (promiseValue && promiseValue.articles) {
						let articlesList = "";
						let articleNumber = getArticleNumber();

						if (promiseValue.articles.length > 0 && promiseValue.articles[0].source) {
							let sourceTitle = promiseValue.articles[0].source.name;
							console.debug("Source Title to Show: " + sourceTitle);
							document.getElementById('source-title').innerHTML = sourceTitle;
						}

						let length = promiseValue.articles.length > articleNumber ? articleNumber : promiseValue.articles.length;
						console.debug("Article Number to Show: " + length);

						for (let i = 0; i < length; i++) {
							let article = promiseValue.articles[i];
							articlesList += `<div class="article">
							<h2><a href="${article.url}" target="_blank">${article.title}</a></h2>`;
							if (article.publishedAt) {
								let date = new Date(Date.parse(article.publishedAt));
								articlesList += `<div class="date">Published: ${date}</div>`;
							}
							if (article.urlToImage) {
								articlesList += `<img src="${article.urlToImage}" alt="">`;
							}
							if (article.content) {
								articlesList += `<p>${article.content}</p>`;
							} else if (article.description) {
								articlesList += `<p>${article.description}</p>`;
							}
							articlesList += `</div>`;
						}

						document.getElementById('articles-list').innerHTML = articlesList;
					}
				});
			})
			.catch(() => console.error(`Response Error from: ${currentSourceId}`));
	};

	document.getElementById('articles-number').addEventListener('change', loadSource);

	const sourcesUrl = "https://newsapi.org/v2/sources?apiKey=2b17f156630a4c0caf074c1251e75c02";
	const sourcesReq = new Request(sourcesUrl);

	fetch(sourcesReq)
		.then((sourcesResponse) => {
			let result = sourcesResponse.json();

			result.then((promiseValue) => {
				if (promiseValue && promiseValue.sources && promiseValue.sources.length > 0) {
					let list = "";
					for (let i = 0; i < promiseValue.sources.length; i++) {
						list += `<li id= ${promiseValue.sources[i].id}  >  ${promiseValue.sources[i].name}  </li>`;
					}

					document.getElementById('sources-list').innerHTML += list;

					currentSourceId = promiseValue.sources[0].id;
					loadSource();

					let items = document.getElementById('sources-list').getElementsByTagName('li');

					for (let i = 0; i < items.length; i++) {
						items[i].addEventListener("click", onSourceClick);
					}
				}
			});
		})
		.catch(() => console.error(`Response Error from: ${sourcesUrl}`));

	const toggleExpander = () => {
		let sideBlock = document.getElementById('side-block');
		let sideBlockClass = sideBlock.getAttribute('class');
		if (sideBlockClass === 'collapsed') {
			sideBlock.removeAttribute('class')
		} else {
			sideBlock.setAttribute('class', 'collapsed')
		}
	};
	document.getElementById('expander').addEventListener("click", toggleExpander);

</script>

</body>
</html>
